<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Business Empire</title>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      overflow-x: hidden;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    html, body {
      height: 100%;
    }

    .mobile-container {
      max-width: 100%;
      margin: 0 auto;
      padding: 10px;
      min-height: 100%;
      position: relative;
    }

    .top-bar {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 15px 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
    }

    .game-title {
      font-size: 24px;
      font-weight: 800;
      color: #1a202c;
      margin: 0 0 5px 0;
      text-align: center;
    }

    .company-name {
      font-size: 14px;
      color: #667eea;
      font-weight: 600;
      text-align: center;
      margin-bottom: 15px;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }

    .stat-mini {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 12px 8px;
      border-radius: 12px;
      color: white;
      text-align: center;
    }

    .stat-mini-label {
      font-size: 10px;
      opacity: 0.9;
      margin-bottom: 2px;
    }

    .stat-mini-value {
      font-size: 14px;
      font-weight: 700;
    }

    .city-selector {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .city-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 8px;
    }

    .city-card {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
    }

    .city-card.active {
      background: #667eea;
      color: white;
      border-color: #5a67d8;
      transform: scale(1.05);
    }

    .city-card:active {
      transform: scale(0.95);
    }

    .city-emoji {
      font-size: 20px;
      display: block;
      margin-bottom: 5px;
    }

    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-top: 1px solid #e2e8f0;
      padding: 10px;
      z-index: 100;
    }

    .nav-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 5px;
      max-width: 500px;
      margin: 0 auto;
    }

    .nav-btn {
      background: transparent;
      border: none;
      padding: 8px 4px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      font-size: 10px;
      color: #4a5568;
    }

    .nav-btn.active {
      background: #667eea;
      color: white;
    }

    .nav-btn:active {
      transform: scale(0.9);
    }

    .nav-icon {
      font-size: 20px;
      display: block;
      margin-bottom: 2px;
    }

    .content-area {
      padding-bottom: 80px;
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-content {
      background: white;
      border-radius: 20px 20px 0 0;
      width: 100%;
      max-width: 500px;
      max-height: 80%;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      position: sticky;
      top: 0;
      background: white;
      border-radius: 20px 20px 0 0;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 700;
      color: #1a202c;
      margin: 0;
      text-align: center;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: #f7fafc;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 16px;
    }

    .modal-body {
      padding: 20px;
    }

    .card {
      background: #f7fafc;
      border: 2px solid #e2e8f0;
      border-radius: 15px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.2s;
    }

    .card:active {
      transform: scale(0.98);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: #1a202c;
    }

    .card-badge {
      background: #667eea;
      color: white;
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 600;
    }

    .card-info {
      font-size: 13px;
      color: #4a5568;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      flex: 1;
      text-align: center;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn:active:not(:disabled) {
      transform: scale(0.95);
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-success {
      background: #48bb78;
      color: white;
    }

    .btn-warning {
      background: #ed8936;
      color: white;
    }

    .btn-danger {
      background: #f56565;
      color: white;
    }

    .btn-secondary {
      background: #e2e8f0;
      color: #4a5568;
    }

    .investment-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .investment-card {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .investment-card:active {
      transform: scale(0.95);
    }

    .investment-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .investment-name {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .investment-yield {
      font-size: 10px;
      opacity: 0.9;
    }

    .risk-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .risk-low { background: #48bb78; }
    .risk-medium { background: #ed8936; }
    .risk-high { background: #f56565; }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #718096;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .toast {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a202c;
      color: white;
      padding: 12px 20px;
      border-radius: 25px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      animation: toastSlide 0.3s ease-out;
      z-index: 2000;
      max-width: 90%;
      text-align: center;
      font-size: 14px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: #e2e8f0;
      border-radius: 3px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
    }

    .floating-btn {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
      z-index: 99;
      transition: all 0.2s;
    }

    .floating-btn:active {
      transform: scale(0.9);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    @keyframes toastSlide {
      from { 
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
      }
      to { 
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .achievement-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(135deg, #f6ad55 0%, #ed8936 100%);
      color: white;
      padding: 20px;
      border-radius: 20px;
      text-align: center;
      z-index: 2000;
      animation: achievementPop 0.5s ease-out;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    @keyframes achievementPop {
      0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
      50% { transform: translate(-50%, -50%) scale(1.1); }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #ffffff40;
      border-radius: 50%;
      border-top-color: #ffffff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script>
    // Paste dataSdk here
    window.dataSdk = (function() {
      let dataHandler = null;
      let store = JSON.parse(localStorage.getItem('gameData')) || [];

      function notify() {
        if (dataHandler && typeof dataHandler.onDataChanged === 'function') {
          dataHandler.onDataChanged([...store]);
        }
      }

      return {
        async init(handler) {
          dataHandler = handler;
          notify();
          return { isOk: true };
        },
        async create(item) {
          store.push(item);
          localStorage.setItem('gameData', JSON.stringify(store));
          notify();
          return { isOk: true };
        },
        async update(item) {
          const index = store.findIndex(b => b.id === item.id);
          if (index !== -1) {
            store[index] = item;
            localStorage.setItem('gameData', JSON.stringify(store));
            notify();
            return { isOk: true };
          } else {
            return { isOk: false };
          }
        },
        async delete(item) {
          const index = store.findIndex(b => b.id === item.id);
          if (index !== -1) {
            store.splice(index, 1);
            localStorage.setItem('gameData', JSON.stringify(store));
            notify();
            return { isOk: true };
          } else {
            return { isOk: false };
          }
        },
        async getAll() {
          return [...store];
        }
      };
    })();

    // Paste elementSdk here
    window.elementSdk = (function() {
      let configStore = {};
      return {
        async init({ defaultConfig, onConfigChange }) {
          configStore = { ...defaultConfig };
          if (typeof onConfigChange === 'function') {
            onConfigChange(configStore);
          }
          return { isOk: true };
        },
        setConfig(newConfig) {
          configStore = { ...configStore, ...newConfig };
          if (newConfig.background_color) document.body.style.backgroundColor = newConfig.background_color;
          if (newConfig.text_color) document.body.style.color = newConfig.text_color;
        },
        getConfig() {
          return { ...configStore };
        }
      };
    })();
  </script>
  <script src="tailwindcss.js" type="text/javascript"></script>
 </head>
 <body>
  <div class="mobile-container">
   <div class="top-bar">
    <div class="game-title" id="game-title">
     Mobile Business Empire
    </div>
    <div class="company-name" id="company-name">
     Global Dynamics Corp
    </div>
    <div class="stats-row">
     <div class="stat-mini">
      <div class="stat-mini-label">
       üí∞ Cash
      </div>
      <div class="stat-mini-value" id="cash">
       $25K
      </div>
     </div>
     <div class="stat-mini">
      <div class="stat-mini-label">
       üìà Income
      </div>
      <div class="stat-mini-value" id="income">
       $0/s
      </div>
     </div>
     <div class="stat-mini">
      <div class="stat-mini-label">
       üèÜ Level
      </div>
      <div class="stat-mini-value" id="player-level">
       1
      </div>
     </div>
    </div>
    <div class="stats-row">
     <div class="stat-mini">
      <div class="stat-mini-label">
       üè¢ Businesses
      </div>
      <div class="stat-mini-value" id="business-count">
       0
      </div>
     </div>
     <div class="stat-mini">
      <div class="stat-mini-label">
       üìä Investments
      </div>
      <div class="stat-mini-value" id="investment-count">
       0
      </div>
     </div>
     <div class="stat-mini">
      <div class="stat-mini-label">
       ü§ù Partners
      </div>
      <div class="stat-mini-value" id="partnership-count">
       0
      </div>
     </div>
    </div>
   </div>
   <div class="city-selector">
    <div class="city-grid" id="city-grid"></div>
   </div>
   <div class="content-area" id="content-area"><!-- Dynamic content based on selected tab -->
   </div><button class="floating-btn" onclick="showQuickActions()" id="quick-btn">‚ö°</button>
   <div class="bottom-nav">
    <div class="nav-grid"><button class="nav-btn active" onclick="switchTab('businesses')" id="nav-businesses"> <span class="nav-icon">üè¢</span> <span>Business</span> </button> <button class="nav-btn" onclick="switchTab('investments')" id="nav-investments"> <span class="nav-icon">üìä</span> <span>Invest</span> </button> <button class="nav-btn" onclick="switchTab('market')" id="nav-market"> <span class="nav-icon">üè™</span> <span>Market</span> </button> <button class="nav-btn" onclick="switchTab('portfolio')" id="nav-portfolio"> <span class="nav-icon">üíº</span> <span>Portfolio</span> </button> <button class="nav-btn" onclick="switchTab('achievements')" id="nav-achievements"> <span class="nav-icon">üèÜ</span> <span>Goals</span> </button>
    </div>
   </div>
  </div>
  <script>
    const CITIES = [
      { id: 'newyork', emoji: 'üóΩ', name: 'New York', multiplier: 1.8, unlockLevel: 1 },
      { id: 'london', emoji: 'üá¨üáß', name: 'London', multiplier: 1.6, unlockLevel: 2 },
      { id: 'tokyo', emoji: 'üóæ', name: 'Tokyo', multiplier: 1.7, unlockLevel: 3 },
      { id: 'singapore', emoji: 'üá∏üá¨', name: 'Singapore', multiplier: 1.5, unlockLevel: 4 },
      { id: 'dubai', emoji: 'üèúÔ∏è', name: 'Dubai', multiplier: 2.0, unlockLevel: 5 },
      { id: 'sydney', emoji: 'üá¶üá∫', name: 'Sydney', multiplier: 1.4, unlockLevel: 6 },
      { id: 'mumbai', emoji: 'üáÆüá≥', name: 'Mumbai', multiplier: 1.3, unlockLevel: 7 },
      { id: 'saopaulo', emoji: 'üáßüá∑', name: 'S√£o Paulo', multiplier: 1.2, unlockLevel: 8 },
      { id: 'moscow', emoji: 'üá∑üá∫', name: 'Moscow', multiplier: 1.6, unlockLevel: 9 },
      { id: 'lagos', emoji: 'üá≥üá¨', name: 'Lagos', multiplier: 1.1, unlockLevel: 10 }
    ];

    const BUSINESS_TEMPLATES = [
      { id: 'food_truck', name: 'üöö Food Truck', baseCost: 1000, baseRevenue: 5, category: 'food' },
      { id: 'cafe', name: '‚òï Coffee Shop', baseCost: 5000, baseRevenue: 25, category: 'food' },
      { id: 'restaurant', name: 'üçï Restaurant', baseCost: 25000, baseRevenue: 125, category: 'food' },
      { id: 'boutique', name: 'üëó Boutique', baseCost: 15000, baseRevenue: 75, category: 'retail' },
      { id: 'electronics', name: 'üì± Electronics Store', baseCost: 50000, baseRevenue: 250, category: 'retail' },
      { id: 'app_dev', name: 'üì± App Development', baseCost: 75000, baseRevenue: 375, category: 'tech' },
      { id: 'ai_startup', name: 'ü§ñ AI Startup', baseCost: 200000, baseRevenue: 1000, category: 'tech' },
      { id: 'crypto_mining', name: '‚Çø Crypto Mining', baseCost: 500000, baseRevenue: 2500, category: 'crypto' },
      { id: 'real_estate', name: 'üè† Real Estate', baseCost: 1000000, baseRevenue: 5000, category: 'property' },
      { id: 'space_tourism', name: 'üöÄ Space Tourism', baseCost: 10000000, baseRevenue: 50000, category: 'future' }
    ];

    const INVESTMENT_TYPES = [
      { id: 'stocks', name: 'Stock Market', icon: 'üìà', yield: 0.08, risk: 'medium', minInvest: 1000 },
      { id: 'bonds', name: 'Government Bonds', icon: 'üèõÔ∏è', yield: 0.04, risk: 'low', minInvest: 5000 },
      { id: 'crypto', name: 'Cryptocurrency', icon: '‚Çø', yield: 0.15, risk: 'high', minInvest: 500 },
      { id: 'commodities', name: 'Gold & Oil', icon: 'ü•á', yield: 0.06, risk: 'medium', minInvest: 2000 },
      { id: 'startups', name: 'Startup Funding', icon: 'üöÄ', yield: 0.25, risk: 'high', minInvest: 10000 },
      { id: 'forex', name: 'Foreign Exchange', icon: 'üí±', yield: 0.12, risk: 'high', minInvest: 1000 },
      { id: 'reits', name: 'Real Estate Funds', icon: 'üè¢', yield: 0.07, risk: 'medium', minInvest: 3000 },
      { id: 'art', name: 'Art & Collectibles', icon: 'üé®', yield: 0.10, risk: 'medium', minInvest: 15000 },
      { id: 'green_energy', name: 'Green Energy', icon: 'üå±', yield: 0.09, risk: 'medium', minInvest: 5000 },
      { id: 'biotech', name: 'Biotech Research', icon: 'üß¨', yield: 0.20, risk: 'high', minInvest: 25000 }
    ];

    let gameState = {
      cash: 25000,
      startTime: Date.now(),
      lastTick: Date.now(),
      currentCity: 'newyork',
      currentTab: 'businesses',
      playerLevel: 1,
      experience: 0,
      entities: [],
      achievements: [],
      lastEventTime: Date.now(),
      totalEarnings: 0
    };

    function saveGame() {
      try {
        localStorage.setItem('businessEmpireGame', JSON.stringify(gameState));
      } catch (e) {
        console.log('Could not save game state');
      }
    }

    function loadGame() {
      try {
        const saved = localStorage.getItem('businessEmpireGame');
        if (saved) {
          const loadedState = JSON.parse(saved);
          gameState = { ...gameState, ...loadedState };
          gameState.lastTick = Date.now(); // Reset tick timer
        }
      } catch (e) {
        console.log('Could not load game state');
      }
    }

    function init() {
      loadGame();
      renderCityGrid();
      renderCurrentTab();
      startGameLoop();
      showWelcomeMessage();
    }

    function showWelcomeMessage() {
      setTimeout(() => {
        showToast('Welcome to Mobile Business Empire! Start by buying your first business.');
      }, 1000);
    }

    function renderCityGrid() {
      const container = document.getElementById('city-grid');
      container.innerHTML = '';
      
      CITIES.forEach(city => {
        const isUnlocked = gameState.playerLevel >= city.unlockLevel;
        const isActive = city.id === gameState.currentCity;
        
        const div = document.createElement('div');
        div.className = `city-card ${isActive ? 'active' : ''} ${!isUnlocked ? 'locked' : ''}`;
        div.style.opacity = isUnlocked ? '1' : '0.5';
        div.innerHTML = `
          <span class="city-emoji">${city.emoji}</span>
          <div>${city.name}</div>
          ${!isUnlocked ? `<div style="font-size: 10px; color: #f56565;">Lv.${city.unlockLevel}</div>` : ''}
        `;
        
        if (isUnlocked) {
          div.onclick = () => switchCity(city.id);
        } else {
          div.onclick = () => showUnlockGuidance(city);
        }
        
        container.appendChild(div);
      });
    }

    function switchCity(cityId) {
      gameState.currentCity = cityId;
      renderCityGrid();
      renderCurrentTab();
      saveGame();
      
      const city = CITIES.find(c => c.id === cityId);
      showToast(`Switched to ${city.name} (${city.multiplier}x multiplier)`);
    }

    function switchTab(tabName) {
      gameState.currentTab = tabName;
      
      // Update nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`nav-${tabName}`).classList.add('active');
      
      renderCurrentTab();
    }

    function renderCurrentTab() {
      const container = document.getElementById('content-area');
      
      switch (gameState.currentTab) {
        case 'businesses':
          renderBusinessesTab(container);
          break;
        case 'investments':
          renderInvestmentsTab(container);
          break;
        case 'market':
          renderMarketTab(container);
          break;
        case 'portfolio':
          renderPortfolioTab(container);
          break;
        case 'achievements':
          renderAchievementsTab(container);
          break;
      }
    }

    function renderBusinessesTab(container) {
      const city = CITIES.find(c => c.id === gameState.currentCity);
      const ownedBusinesses = gameState.entities.filter(e => 
        e.entity_type === 'business' && 
        e.owner_type === 'player' && 
        e.city === gameState.currentCity
      );

      container.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">
            üè¢ Available Businesses in ${city.name}
          </h3>
          <div id="available-businesses"></div>
        </div>
        
        <div>
          <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">
            üèÜ Your Businesses (${ownedBusinesses.length})
          </h3>
          <div id="owned-businesses"></div>
        </div>
      `;

      renderAvailableBusinesses();
      renderOwnedBusinesses();
    }

    function renderAvailableBusinesses() {
      const container = document.getElementById('available-businesses');
      const city = CITIES.find(c => c.id === gameState.currentCity);
      
      container.innerHTML = '';
      
      BUSINESS_TEMPLATES.forEach(template => {
        const ownedCount = gameState.entities.filter(e => 
          e.entity_type === 'business' && 
          e.business_type === template.id && 
          e.city === gameState.currentCity &&
          e.owner_type === 'player'
        ).length;
        
        const cost = Math.floor(template.baseCost * city.multiplier * Math.pow(1.15, ownedCount));
        const revenue = Math.floor(template.baseRevenue * city.multiplier * Math.pow(1.15, ownedCount));

        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="card-header">
            <div class="card-title">${template.name}</div>
            <div class="card-badge">Owned: ${ownedCount}</div>
          </div>
          <div class="card-info">
            üíµ Cost: $${formatNumber(cost)}<br>
            üìä Revenue: $${formatNumber(revenue)}/sec<br>
            üåç City Bonus: ${city.multiplier}x
          </div>
          <div class="card-actions">
            <button class="btn btn-primary" onclick="showPurchaseModal('${template.id}')" 
              ${gameState.cash < cost ? 'disabled' : ''}>
              ${gameState.cash < cost ? 'Need $' + formatNumber(cost - gameState.cash) : 'Purchase'}
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderOwnedBusinesses() {
      const container = document.getElementById('owned-businesses');
      const ownedBusinesses = gameState.entities.filter(e => 
        e.entity_type === 'business' && 
        e.owner_type === 'player' && 
        e.city === gameState.currentCity
      );

      if (ownedBusinesses.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üè¢</div>
            <div>No businesses in this city yet.<br>Start building your empire!</div>
          </div>
        `;
        return;
      }

      container.innerHTML = '';
      ownedBusinesses.forEach(business => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="card-header">
            <div class="card-title">${business.name}</div>
            <div class="card-badge">Lv.${business.level}</div>
          </div>
          <div class="card-info">
            üìä Revenue: $${formatNumber(business.revenue_per_tick)}/sec<br>
            ‚¨ÜÔ∏è Upgrade: $${formatNumber(business.upgrade_cost)}<br>
            üí∞ Value: $${formatNumber(business.market_value)}
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${Math.min(100, (business.level / 10) * 100)}%"></div>
            </div>
          </div>
          <div class="card-actions">
            <button class="btn btn-success" onclick="upgradeBusiness('${business.id}')"
              ${gameState.cash < business.upgrade_cost ? 'disabled' : ''}>
              Upgrade
            </button>
            <button class="btn btn-danger" onclick="showSellModal('${business.id}')">
              Sell
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderInvestmentsTab(container) {
      container.innerHTML = `
        <div style="margin-bottom: 20px;">
          <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">
            üìä Investment Opportunities
          </h3>
          <div class="investment-grid" id="investment-grid"></div>
        </div>
        
        <div>
          <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">
            üíº Your Investments
          </h3>
          <div id="your-investments"></div>
        </div>
      `;

      renderInvestmentGrid();
      renderYourInvestments();
    }

    function renderInvestmentGrid() {
      const container = document.getElementById('investment-grid');
      container.innerHTML = '';
      
      INVESTMENT_TYPES.forEach(investment => {
        const div = document.createElement('div');
        div.className = 'investment-card';
        div.style.background = getInvestmentGradient(investment.risk);
        div.innerHTML = `
          <div class="risk-indicator risk-${investment.risk}"></div>
          <div class="investment-icon">${investment.icon}</div>
          <div class="investment-name">${investment.name}</div>
          <div class="investment-yield">${(investment.yield * 100).toFixed(1)}% APY</div>
          <div style="font-size: 10px; margin-top: 4px;">Min: $${formatNumber(investment.minInvest)}</div>
        `;
        div.onclick = () => showInvestmentModal(investment);
        container.appendChild(div);
      });
    }

    function getInvestmentGradient(risk) {
      switch (risk) {
        case 'low': return 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
        case 'medium': return 'linear-gradient(135deg, #ed8936 0%, #dd6b20 100%)';
        case 'high': return 'linear-gradient(135deg, #f56565 0%, #e53e3e 100%)';
        default: return 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      }
    }

    function renderYourInvestments() {
      const container = document.getElementById('your-investments');
      const investments = gameState.entities.filter(e => e.entity_type === 'investment');

      if (investments.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üìä</div>
            <div>No investments yet.<br>Diversify your portfolio!</div>
          </div>
        `;
        return;
      }

      container.innerHTML = '';
      investments.forEach(investment => {
        const investmentType = INVESTMENT_TYPES.find(t => t.id === investment.investment_type);
        const dailyReturn = investment.market_value * investment.yield_rate / 365;
        
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="card-header">
            <div class="card-title">${investmentType.icon} ${investmentType.name}</div>
            <div class="card-badge risk-${investment.risk_level}">${investment.risk_level}</div>
          </div>
          <div class="card-info">
            üí∞ Invested: $${formatNumber(investment.market_value)}<br>
            üìà Daily Return: $${formatNumber(dailyReturn)}<br>
            üéØ APY: ${(investment.yield_rate * 100).toFixed(1)}%
          </div>
          <div class="card-actions">
            <button class="btn btn-success" onclick="addToInvestment('${investment.id}')">
              Add More
            </button>
            <button class="btn btn-warning" onclick="withdrawInvestment('${investment.id}')">
              Withdraw
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderMarketTab(container) {
      const npcBusinesses = gameState.entities.filter(e => 
        e.entity_type === 'business' && 
        e.owner_type === 'npc' && 
        e.city === gameState.currentCity
      );

      container.innerHTML = `
        <div>
          <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">
            üè™ Market Opportunities in ${CITIES.find(c => c.id === gameState.currentCity).name}
          </h3>
          <div id="market-businesses"></div>
        </div>
      `;

      renderMarketBusinesses(npcBusinesses);
    }

    function renderMarketBusinesses(businesses) {
      const container = document.getElementById('market-businesses');
      
      if (businesses.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üè™</div>
            <div>No market opportunities in this city yet.</div>
          </div>
        `;
        return;
      }

      container.innerHTML = '';
      businesses.forEach(business => {
        const npcData = JSON.parse(business.data || '{}');
        const availableShares = business.total_shares - business.shares_owned;
        const sharePrice = Math.floor(business.market_value / business.total_shares);

        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="card-header">
            <div class="card-title">${business.name}</div>
            <div class="card-badge">Lv.${business.level}</div>
          </div>
          <div class="card-info">
            üë§ Owner: ${npcData.npc_name}<br>
            üìä Revenue: $${formatNumber(business.revenue_per_tick)}/sec<br>
            üí∞ Share Price: $${formatNumber(sharePrice)}<br>
            üìà Available: ${availableShares}%
          </div>
          <div class="card-actions">
            <button class="btn btn-warning" onclick="investInBusiness('${business.id}', 10)" 
              ${gameState.cash < sharePrice * 10 || availableShares < 10 ? 'disabled' : ''}>
              Buy 10%
            </button>
            <button class="btn btn-success" onclick="proposePartnership('${business.id}')" 
              ${business.partnership_type ? 'disabled' : ''}>
              Partner
            </button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderPortfolioTab(container) {
      const totalValue = calculatePortfolioValue();
      const monthlyIncome = calculateMonthlyIncome();
      
      container.innerHTML = `
        <div style="background: rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; margin-bottom: 20px; color: white;">
          <h3 style="margin: 0 0 15px 0; text-align: center;">üíº Portfolio Overview</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
            <div>
              <div style="font-size: 24px; font-weight: bold;">$${formatNumber(totalValue)}</div>
              <div style="font-size: 12px; opacity: 0.8;">Total Value</div>
            </div>
            <div>
              <div style="font-size: 24px; font-weight: bold;">$${formatNumber(monthlyIncome)}</div>
              <div style="font-size: 12px; opacity: 0.8;">Monthly Income</div>
            </div>
          </div>
        </div>
        
        <div>
          <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">üìä Asset Breakdown</h3>
          <div id="portfolio-breakdown"></div>
        </div>
      `;

      renderPortfolioBreakdown();
    }

    function renderPortfolioBreakdown() {
      const container = document.getElementById('portfolio-breakdown');
      const businesses = gameState.entities.filter(e => e.entity_type === 'business' && e.owner_type === 'player');
      const investments = gameState.entities.filter(e => e.entity_type === 'investment');
      const shares = gameState.entities.filter(e => e.entity_type === 'business' && e.owner_type === 'npc' && e.shares_owned > 0);

      container.innerHTML = '';

      // Business summary
      if (businesses.length > 0) {
        const businessValue = businesses.reduce((sum, b) => sum + b.market_value, 0);
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="card-header">
            <div class="card-title">üè¢ Your Businesses</div>
            <div class="card-badge">${businesses.length}</div>
          </div>
          <div class="card-info">
            üí∞ Total Value: $${formatNumber(businessValue)}<br>
            üìä Monthly Revenue: $${formatNumber(businesses.reduce((sum, b) => sum + b.revenue_per_tick * 30 * 24 * 3600, 0))}
          </div>
        `;
        container.appendChild(div);
      }

      // Investment summary
      if (investments.length > 0) {
        const investmentValue = investments.reduce((sum, i) => sum + i.market_value, 0);
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="card-header">
            <div class="card-title">üìä Investments</div>
            <div class="card-badge">${investments.length}</div>
          </div>
          <div class="card-info">
            üí∞ Total Invested: $${formatNumber(investmentValue)}<br>
            üìà Monthly Returns: $${formatNumber(investments.reduce((sum, i) => sum + (i.market_value * i.yield_rate / 12), 0))}
          </div>
        `;
        container.appendChild(div);
      }

      // Shares summary
      if (shares.length > 0) {
        const sharesValue = shares.reduce((sum, s) => sum + (s.market_value * s.shares_owned / 100), 0);
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="card-header">
            <div class="card-title">ü§ù Share Holdings</div>
            <div class="card-badge">${shares.length}</div>
          </div>
          <div class="card-info">
            üí∞ Total Value: $${formatNumber(sharesValue)}<br>
            üìä Monthly Dividends: $${formatNumber(shares.reduce((sum, s) => sum + (s.revenue_per_tick * s.shares_owned / 100 * 30 * 24 * 3600), 0))}
          </div>
        `;
        container.appendChild(div);
      }

      if (businesses.length === 0 && investments.length === 0 && shares.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üíº</div>
            <div>Your portfolio is empty.<br>Start building your empire!</div>
          </div>
        `;
      }
    }

    function renderAchievementsTab(container) {
      container.innerHTML = `
        <div>
          <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">üèÜ Achievements</h3>
          <div id="achievements-list"></div>
        </div>
        
        <div style="margin-top: 30px;">
          <h3 style="margin: 0 0 15px 0; color: white; text-align: center;">üéØ Goals</h3>
          <div id="goals-list"></div>
        </div>
      `;

      renderAchievements();
      renderGoals();
    }

    function renderAchievements() {
      const container = document.getElementById('achievements-list');
      
      if (gameState.achievements.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üèÜ</div>
            <div>No achievements yet.<br>Keep building your empire!</div>
          </div>
        `;
        return;
      }

      container.innerHTML = '';
      gameState.achievements.forEach(achievement => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.background = 'linear-gradient(135deg, #f6ad55 0%, #ed8936 100%)';
        div.style.color = 'white';
        div.innerHTML = `
          <div class="card-title">${achievement}</div>
        `;
        container.appendChild(div);
      });
    }

    function renderGoals() {
      const container = document.getElementById('goals-list');
      const goals = [
        { text: 'Own 5 businesses', progress: Math.min(100, (gameState.entities.filter(e => e.entity_type === 'business' && e.owner_type === 'player').length / 5) * 100) },
        { text: 'Reach $100K cash', progress: Math.min(100, (gameState.cash / 100000) * 100) },
        { text: 'Unlock 5 cities', progress: Math.min(100, (gameState.playerLevel / 5) * 100) },
        { text: 'Make 10 investments', progress: Math.min(100, (gameState.entities.filter(e => e.entity_type === 'investment').length / 10) * 100) }
      ];

      container.innerHTML = '';
      goals.forEach(goal => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <div class="card-info">
            ${goal.text}
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${goal.progress}%"></div>
            </div>
            <div style="text-align: right; font-size: 12px; margin-top: 5px;">${goal.progress.toFixed(0)}%</div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function showPurchaseModal(templateId) {
      const template = BUSINESS_TEMPLATES.find(t => t.id === templateId);
      const city = CITIES.find(c => c.id === gameState.currentCity);
      const ownedCount = gameState.entities.filter(e => 
        e.entity_type === 'business' && 
        e.business_type === templateId && 
        e.city === gameState.currentCity &&
        e.owner_type === 'player'
      ).length;
      
      const cost = Math.floor(template.baseCost * city.multiplier * Math.pow(1.15, ownedCount));
      const revenue = Math.floor(template.baseRevenue * city.multiplier * Math.pow(1.15, ownedCount));

      showModal('Purchase Business', `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 10px;">${template.name.split(' ')[0]}</div>
          <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">${template.name}</div>
          <div style="color: #666;">in ${city.name}</div>
        </div>
        
        <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <div style="margin-bottom: 10px;">üíµ <strong>Cost:</strong> $${formatNumber(cost)}</div>
          <div style="margin-bottom: 10px;">üìä <strong>Revenue:</strong> $${formatNumber(revenue)}/sec</div>
          <div style="margin-bottom: 10px;">üåç <strong>City Bonus:</strong> ${city.multiplier}x</div>
          <div>üè¢ <strong>You own:</strong> ${ownedCount} of this type</div>
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
          <button class="btn btn-primary" onclick="purchaseBusiness('${templateId}')" style="flex: 1;" 
            ${gameState.cash < cost ? 'disabled' : ''}>
            ${gameState.cash < cost ? 'Not Enough Cash' : 'Purchase'}
          </button>
        </div>
      `);
    }

    function showInvestmentModal(investment) {
      showModal('Investment Opportunity', `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 10px;">${investment.icon}</div>
          <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">${investment.name}</div>
          <div style="color: ${investment.risk === 'high' ? '#f56565' : investment.risk === 'medium' ? '#ed8936' : '#48bb78'};">
            ${investment.risk.toUpperCase()} RISK
          </div>
        </div>
        
        <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <div style="margin-bottom: 10px;">üìà <strong>Annual Yield:</strong> ${(investment.yield * 100).toFixed(1)}%</div>
          <div style="margin-bottom: 10px;">üí∞ <strong>Minimum Investment:</strong> $${formatNumber(investment.minInvest)}</div>
          <div>‚ö†Ô∏è <strong>Risk Level:</strong> ${investment.risk}</div>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Investment Amount:</label>
          <input type="number" id="investment-amount" placeholder="Enter amount" 
            style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px;"
            min="${investment.minInvest}" step="1000" value="${investment.minInvest}">
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Cancel</button>
          <button class="btn btn-primary" onclick="makeInvestment('${investment.id}')" style="flex: 1;">
            Invest Now
          </button>
        </div>
      `);
    }

    function showModal(title, content) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.id = 'current-modal';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title">${title}</h2>
            <button class="modal-close" onclick="closeModal()">√ó</button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // Close on backdrop click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
      });
    }

    function closeModal() {
      const modal = document.getElementById('current-modal');
      if (modal) {
        modal.remove();
      }
    }

    function showQuickActions() {
      showModal('Quick Actions', `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <button class="btn btn-primary" onclick="autoInvest(); closeModal();">
            ü§ñ Auto Invest
          </button>
          <button class="btn btn-success" onclick="collectAllRevenue(); closeModal();">
            üí∞ Collect All
          </button>
          <button class="btn btn-warning" onclick="upgradeAll(); closeModal();">
            ‚¨ÜÔ∏è Upgrade All
          </button>
          <button class="btn btn-secondary" onclick="showStats(); closeModal();">
            üìä Statistics
          </button>
        </div>
      `);
    }

    function purchaseBusiness(templateId) {
      const template = BUSINESS_TEMPLATES.find(t => t.id === templateId);
      const city = CITIES.find(c => c.id === gameState.currentCity);
      const ownedCount = gameState.entities.filter(e => 
        e.entity_type === 'business' && 
        e.business_type === templateId && 
        e.city === gameState.currentCity &&
        e.owner_type === 'player'
      ).length;
      
      const cost = Math.floor(template.baseCost * city.multiplier * Math.pow(1.15, ownedCount));

      if (gameState.cash < cost) {
        showToast('Not enough cash!');
        return;
      }

      gameState.cash -= cost;
      gameState.experience += 10;

      const business = {
        id: `${templateId}_${gameState.currentCity}_${Date.now()}`,
        entity_type: 'business',
        name: template.name,
        city: gameState.currentCity,
        owner_type: 'player',
        owner_id: 'player',
        business_type: templateId,
        investment_type: '',
        level: 1,
        revenue_per_tick: Math.floor(template.baseRevenue * city.multiplier),
        cost: cost,
        upgrade_cost: Math.floor(cost * 1.5),
        market_value: Math.floor(cost * 1.2),
        shares_owned: 0,
        total_shares: 100,
        partnership_type: '',
        partnership_terms: '',
        created_at: new Date().toISOString(),
        last_updated: new Date().toISOString(),
        status: 'active',
        data: JSON.stringify({ city_multiplier: city.multiplier }),
        risk_level: '',
        yield_rate: 0
      };

      gameState.entities.push(business);
      saveGame();
      showToast(`üéâ Purchased ${template.name}!`);
      closeModal();
      renderCurrentTab();
      updateStats();
    }

    function makeInvestment(investmentTypeId) {
      const investmentType = INVESTMENT_TYPES.find(t => t.id === investmentTypeId);
      const amount = parseInt(document.getElementById('investment-amount').value);

      if (!amount || amount < investmentType.minInvest) {
        showToast(`Minimum investment is $${formatNumber(investmentType.minInvest)}`);
        return;
      }

      if (gameState.cash < amount) {
        showToast('Not enough cash!');
        return;
      }

      gameState.cash -= amount;
      gameState.experience += 5;

      const investment = {
        id: `inv_${investmentTypeId}_${Date.now()}`,
        entity_type: 'investment',
        name: investmentType.name,
        city: '',
        owner_type: 'player',
        owner_id: 'player',
        business_type: '',
        investment_type: investmentTypeId,
        level: 1,
        revenue_per_tick: 0,
        cost: amount,
        upgrade_cost: 0,
        market_value: amount,
        shares_owned: 0,
        total_shares: 0,
        partnership_type: '',
        partnership_terms: '',
        created_at: new Date().toISOString(),
        last_updated: new Date().toISOString(),
        status: 'active',
        data: JSON.stringify({ investment_type: investmentTypeId }),
        risk_level: investmentType.risk,
        yield_rate: investmentType.yield
      };

      gameState.entities.push(investment);
      saveGame();
      showToast(`üí∞ Invested $${formatNumber(amount)} in ${investmentType.name}!`);
      closeModal();
      renderCurrentTab();
      updateStats();
    }

    function upgradeBusiness(businessId) {
      const business = gameState.entities.find(e => e.id === businessId);
      if (!business || gameState.cash < business.upgrade_cost) {
        showToast('Not enough cash!');
        return;
      }

      gameState.cash -= business.upgrade_cost;
      gameState.experience += 15;
      business.level += 1;
      business.revenue_per_tick = Math.floor(business.revenue_per_tick * 1.5);
      business.upgrade_cost = Math.floor(business.upgrade_cost * 1.5);
      business.market_value = Math.floor(business.market_value * 1.3);
      business.last_updated = new Date().toISOString();

      saveGame();
      showToast(`‚¨ÜÔ∏è Upgraded ${business.name} to level ${business.level}!`);
      renderCurrentTab();
      updateStats();
    }

    function showSellModal(businessId) {
      const business = gameState.entities.find(e => e.id === businessId);
      const sellPrice = Math.floor(business.market_value * 0.8);

      showModal('Sell Business', `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 10px;">${business.name.split(' ')[0]}</div>
          <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">${business.name}</div>
          <div style="color: #666;">Level ${business.level}</div>
        </div>
        
        <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <div style="margin-bottom: 10px;">üí∞ <strong>Sell Price:</strong> $${formatNumber(sellPrice)}</div>
          <div style="margin-bottom: 10px;">üìä <strong>Current Revenue:</strong> $${formatNumber(business.revenue_per_tick)}/sec</div>
          <div style="color: #f56565; font-size: 12px;">‚ö†Ô∏è You'll lose this business permanently</div>
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button class="btn btn-secondary" onclick="closeModal()" style="flex: 1;">Keep Business</button>
          <button class="btn btn-danger" onclick="sellBusiness('${businessId}')" style="flex: 1;">
            Sell Now
          </button>
        </div>
      `);
    }

    function sellBusiness(businessId) {
      const business = gameState.entities.find(e => e.id === businessId);
      const sellPrice = Math.floor(business.market_value * 0.8);
      
      gameState.cash += sellPrice;
      gameState.entities = gameState.entities.filter(e => e.id !== businessId);
      
      saveGame();
      showToast(`üí∞ Sold ${business.name} for $${formatNumber(sellPrice)}!`);
      closeModal();
      renderCurrentTab();
      updateStats();
    }

    function calculatePortfolioValue() {
      return gameState.entities.reduce((total, entity) => {
        if (entity.entity_type === 'business' && entity.owner_type === 'player') {
          return total + entity.market_value;
        } else if (entity.entity_type === 'investment') {
          return total + entity.market_value;
        } else if (entity.entity_type === 'business' && entity.owner_type === 'npc' && entity.shares_owned > 0) {
          return total + (entity.market_value * entity.shares_owned / 100);
        }
        return total;
      }, 0) + gameState.cash;
    }

    function calculateMonthlyIncome() {
      return gameState.entities.reduce((total, entity) => {
        if (entity.entity_type === 'business' && entity.owner_type === 'player') {
          return total + (entity.revenue_per_tick * 30 * 24 * 3600);
        } else if (entity.entity_type === 'investment') {
          return total + (entity.market_value * entity.yield_rate / 12);
        } else if (entity.entity_type === 'business' && entity.owner_type === 'npc' && entity.shares_owned > 0) {
          return total + (entity.revenue_per_tick * entity.shares_owned / 100 * 30 * 24 * 3600);
        }
        return total;
      }, 0);
    }

    function startGameLoop() {
      setInterval(() => {
        const now = Date.now();
        const deltaTime = (now - gameState.lastTick) / 1000;
        gameState.lastTick = now;

        let totalIncome = 0;
        
        gameState.entities.forEach(entity => {
          if (entity.entity_type === 'business' && entity.owner_type === 'player') {
            totalIncome += entity.revenue_per_tick;
          } else if (entity.entity_type === 'investment') {
            const dailyReturn = entity.market_value * entity.yield_rate / 365;
            totalIncome += dailyReturn / (24 * 3600);
          } else if (entity.entity_type === 'business' && entity.owner_type === 'npc' && entity.shares_owned > 0) {
            const dividendPerShare = entity.revenue_per_tick / entity.total_shares;
            totalIncome += dividendPerShare * entity.shares_owned;
          }
        });

        gameState.cash += totalIncome * deltaTime;
        gameState.totalEarnings += totalIncome * deltaTime;
        updateStats();
        
        // Save periodically
        if (Math.random() < 0.01) { // 1% chance each tick
          saveGame();
        }
      }, 100);

      setInterval(() => {
        checkLevelUp();
        checkAchievements();
      }, 5000);
    }

    function checkLevelUp() {
      const requiredExp = gameState.playerLevel * 100;
      if (gameState.experience >= requiredExp) {
        gameState.playerLevel++;
        gameState.experience = 0;
        
        showAchievementPopup(`üéâ Level Up! You're now level ${gameState.playerLevel}!`);
        renderCityGrid();
        updateStats();
        saveGame();
      }
    }

    function checkAchievements() {
      const newAchievements = [];

      const myBusinesses = gameState.entities.filter(e => e.entity_type === 'business' && e.owner_type === 'player');
      const investments = gameState.entities.filter(e => e.entity_type === 'investment');

      if (myBusinesses.length >= 1 && !gameState.achievements.includes('first_business')) {
        gameState.achievements.push('first_business');
        newAchievements.push('üè¢ First Business Owner!');
      }

      if (investments.length >= 1 && !gameState.achievements.includes('first_investment')) {
        gameState.achievements.push('first_investment');
        newAchievements.push('üìä Smart Investor!');
      }

      if (gameState.cash >= 100000 && !gameState.achievements.includes('hundred_k')) {
        gameState.achievements.push('hundred_k');
        newAchievements.push('üí∞ $100K Club!');
      }

      if (gameState.playerLevel >= 5 && !gameState.achievements.includes('level_5')) {
        gameState.achievements.push('level_5');
        newAchievements.push('üåü Level 5 Tycoon!');
      }

      if (myBusinesses.length >= 10 && !gameState.achievements.includes('ten_businesses')) {
        gameState.achievements.push('ten_businesses');
        newAchievements.push('üèÜ Business Empire!');
      }

      if (newAchievements.length > 0) {
        saveGame();
        newAchievements.forEach(achievement => {
          showAchievementPopup(achievement);
        });
      }
    }

    function showAchievementPopup(text) {
      const popup = document.createElement('div');
      popup.className = 'achievement-popup';
      popup.innerHTML = `
        <div style="font-size: 24px; margin-bottom: 10px;">üèÜ</div>
        <div style="font-weight: bold; font-size: 16px;">${text}</div>
      `;
      
      document.body.appendChild(popup);
      
      setTimeout(() => {
        popup.remove();
      }, 3000);
    }

    function updateStats() {
      document.getElementById('cash').textContent = `$${formatNumber(Math.floor(gameState.cash))}`;
      document.getElementById('player-level').textContent = gameState.playerLevel;
      
      let totalIncome = 0;
      let businessCount = 0;
      let investmentCount = 0;
      let partnershipCount = 0;
      
      gameState.entities.forEach(entity => {
        if (entity.entity_type === 'business' && entity.owner_type === 'player') {
          totalIncome += entity.revenue_per_tick;
          businessCount++;
          if (entity.partnership_type) partnershipCount++;
        } else if (entity.entity_type === 'investment') {
          const dailyReturn = entity.market_value * entity.yield_rate / 365;
          totalIncome += dailyReturn / (24 * 3600);
          investmentCount++;
        } else if (entity.entity_type === 'business' && entity.owner_type === 'npc' && entity.shares_owned > 0) {
          const dividendPerShare = entity.revenue_per_tick / entity.total_shares;
          totalIncome += dividendPerShare * entity.shares_owned;
        }
      });
      
      document.getElementById('income').textContent = `$${formatNumber(Math.floor(totalIncome))}/s`;
      document.getElementById('business-count').textContent = businessCount;
      document.getElementById('investment-count').textContent = investmentCount;
      document.getElementById('partnership-count').textContent = partnershipCount;
    }

    function formatNumber(num) {
      if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
      if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
      if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
      return num.toFixed(0);
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function showUnlockGuidance(city) {
      const levelsNeeded = city.unlockLevel - gameState.playerLevel;
      const expNeeded = (gameState.playerLevel * 100) - gameState.experience;
      
      showModal(`üîí ${city.name} Locked`, `
        <div style="text-align: center; margin-bottom: 20px;">
          <div style="font-size: 48px; margin-bottom: 10px;">${city.emoji}</div>
          <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;">${city.name}</div>
          <div style="color: #f56565; font-weight: bold;">Requires Level ${city.unlockLevel}</div>
        </div>
        
        <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <div style="margin-bottom: 15px;">
            <div style="font-weight: bold; margin-bottom: 5px;">üìä Your Progress:</div>
            <div>Current Level: ${gameState.playerLevel}</div>
            <div>Experience: ${gameState.experience}/100</div>
            <div style="color: #f56565;">Need ${levelsNeeded} more level${levelsNeeded > 1 ? 's' : ''}</div>
          </div>
          
          <div style="margin-bottom: 15px;">
            <div style="font-weight: bold; margin-bottom: 10px;">üöÄ How to Level Up Fast:</div>
            <div style="margin-bottom: 8px;">‚Ä¢ üè¢ Buy businesses (+10 XP each)</div>
            <div style="margin-bottom: 8px;">‚Ä¢ ‚¨ÜÔ∏è Upgrade businesses (+15 XP each)</div>
            <div style="margin-bottom: 8px;">‚Ä¢ üìä Make investments (+5 XP each)</div>
            <div style="margin-bottom: 8px;">‚Ä¢ ü§ù Form partnerships (+20 XP each)</div>
          </div>
          
          <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; border-radius: 8px; font-size: 14px;">
            üí° <strong>Pro Tip:</strong> Focus on buying and upgrading businesses in your current city for maximum XP gain!
          </div>
        </div>
        
        <div style="text-align: center;">
          <button class="btn btn-primary" onclick="closeModal(); switchTab('businesses');" style="width: 100%;">
            Start Building Empire üöÄ
          </button>
        </div>
      `);
    }

    // Auto functions for quick actions
    function autoInvest() {
      const availableCash = gameState.cash * 0.2; // Invest 20% of cash
      const bestInvestment = INVESTMENT_TYPES.find(i => i.minInvest <= availableCash);
      
      if (bestInvestment && availableCash >= bestInvestment.minInvest) {
        gameState.cash -= Math.floor(availableCash);
        gameState.experience += 5;

        const investment = {
          id: `inv_${bestInvestment.id}_${Date.now()}`,
          entity_type: 'investment',
          name: bestInvestment.name,
          city: '',
          owner_type: 'player',
          owner_id: 'player',
          business_type: '',
          investment_type: bestInvestment.id,
          level: 1,
          revenue_per_tick: 0,
          cost: Math.floor(availableCash),
          upgrade_cost: 0,
          market_value: Math.floor(availableCash),
          shares_owned: 0,
          total_shares: 0,
          partnership_type: '',
          partnership_terms: '',
          created_at: new Date().toISOString(),
          last_updated: new Date().toISOString(),
          status: 'active',
          data: JSON.stringify({ investment_type: bestInvestment.id }),
          risk_level: bestInvestment.risk,
          yield_rate: bestInvestment.yield
        };

        gameState.entities.push(investment);
        saveGame();
        showToast(`ü§ñ Auto-invested $${formatNumber(Math.floor(availableCash))} in ${bestInvestment.name}!`);
        renderCurrentTab();
        updateStats();
      } else {
        showToast('Not enough cash for auto-invest');
      }
    }

    function collectAllRevenue() {
      // This is just a visual effect since revenue is already auto-collected
      const totalRevenue = gameState.entities.reduce((sum, e) => {
        if (e.entity_type === 'business' && e.owner_type === 'player') {
          return sum + e.revenue_per_tick * 10; // 10 seconds worth
        }
        return sum;
      }, 0);
      
      if (totalRevenue > 0) {
        gameState.cash += totalRevenue;
        saveGame();
        showToast(`üí∞ Collected $${formatNumber(totalRevenue)} in revenue!`);
        updateStats();
      } else {
        showToast('No revenue to collect');
      }
    }

    function upgradeAll() {
      const businesses = gameState.entities.filter(e => 
        e.entity_type === 'business' && 
        e.owner_type === 'player' && 
        gameState.cash >= e.upgrade_cost
      );
      
      if (businesses.length === 0) {
        showToast('No businesses can be upgraded');
        return;
      }
      
      let upgraded = 0;
      for (const business of businesses.slice(0, 3)) { // Limit to 3 to avoid too many operations
        if (gameState.cash >= business.upgrade_cost) {
          gameState.cash -= business.upgrade_cost;
          gameState.experience += 15;
          business.level += 1;
          business.revenue_per_tick = Math.floor(business.revenue_per_tick * 1.5);
          business.upgrade_cost = Math.floor(business.upgrade_cost * 1.5);
          business.market_value = Math.floor(business.market_value * 1.3);
          business.last_updated = new Date().toISOString();
          upgraded++;
        }
      }
      
      if (upgraded > 0) {
        saveGame();
        showToast(`‚¨ÜÔ∏è Upgraded ${upgraded} businesses!`);
        renderCurrentTab();
        updateStats();
      }
    }

    function showStats() {
      const totalValue = calculatePortfolioValue();
      const monthlyIncome = calculateMonthlyIncome();
      
      showModal('Statistics', `
        <div style="text-align: center;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div style="background: #f7fafc; padding: 15px; border-radius: 10px;">
              <div style="font-size: 24px; font-weight: bold; color: #667eea;">$${formatNumber(totalValue)}</div>
              <div style="font-size: 12px; color: #666;">Total Portfolio Value</div>
            </div>
            <div style="background: #f7fafc; padding: 15px; border-radius: 10px;">
              <div style="font-size: 24px; font-weight: bold; color: #48bb78;">$${formatNumber(monthlyIncome)}</div>
              <div style="font-size: 12px; color: #666;">Monthly Income</div>
            </div>
          </div>
          
          <div style="background: #f7fafc; padding: 15px; border-radius: 10px; text-align: left;">
            <div style="margin-bottom: 10px;">üèÜ <strong>Level:</strong> ${gameState.playerLevel}</div>
            <div style="margin-bottom: 10px;">‚≠ê <strong>Experience:</strong> ${gameState.experience}/100</div>
            <div style="margin-bottom: 10px;">üí∞ <strong>Total Earnings:</strong> $${formatNumber(gameState.totalEarnings)}</div>
            <div>üèÜ <strong>Achievements:</strong> ${gameState.achievements.length}</div>
          </div>
        </div>
      `);
    }

    // Placeholder functions for features not fully implemented
    function addToInvestment(investmentId) {
      showToast('Feature coming soon!');
    }

    function withdrawInvestment(investmentId) {
      showToast('Feature coming soon!');
    }

    function investInBusiness(businessId, percentage) {
      showToast('Feature coming soon!');
    }

    function proposePartnership(businessId) {
      showToast('Feature coming soon!');
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99b5eac9e447bc57',t:'MTc2MjYxMzc4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
